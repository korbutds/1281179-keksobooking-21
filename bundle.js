(()=>{"use strict";(()=>{const e=(e,t)=>Math.floor(Math.random()*(t-e+1))+e;window.util={getRandomIntInclusive:e,getRandomArrayElement:t=>t[e(0,t.length-1)],setDisabledFormElements:e=>{for(const t of e)t.disabled=!0},setUnDisabledFormElements:e=>{for(const t of e)t.disabled=!1}}})(),(()=>{const e=(e,t,o)=>{e.responseType="json",e.addEventListener("load",(()=>{200===e.status?t(e.response):o(`Статус ответа: ${e.status} ${e.statusText}`)})),e.timeout=2e3,e.addEventListener("error",(()=>{o("Произошла ошибка соеденения. Проверьте соеденение с интернетом")})),e.addEventListener("timeout",(()=>{o(`Запрос не успел выполниться за ${e.timeout}мс`)}))};window.server={load:(t,o)=>{const r=new XMLHttpRequest;r.open("GET","https://21.javascript.pages.academy/keksobooking/data"),e(r,t,o),r.send()},send:(t,o,r)=>{const n=new XMLHttpRequest;n.open("POST","https://21.javascript.pages.academy/keksobooking"),e(n,o,r),n.send(t)}}})(),window.data={},window.server.load((e=>{window.data.serverData=e.filter((e=>e.offer))}),(e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)})),(()=>{const e=document.querySelector("main"),t=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),o=t.querySelector(".error__message"),r=t.querySelector(".error__button"),n=()=>{e.removeChild(t),r.removeEventListener("click",a),document.removeEventListener("click",c),document.removeEventListener("keydown",d)},a=()=>{n()},c=()=>{n()},d=e=>{"Escape"===e.key&&n()};window.error={uploadErrorMessage:n=>()=>{(n=>{o.textContent=n,e.insertAdjacentElement("beforeend",t),r.addEventListener("click",a),document.addEventListener("click",c),document.addEventListener("keydown",d)})(n)}}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);window.createSuccessMessage=()=>{e.appendChild(t),window.pageActivate.getDeactivePage(),document.querySelector(".ad-form").reset(),document.addEventListener("click",r),document.addEventListener("keydown",n)};const o=()=>{t.remove(),document.removeEventListener("click",r),document.removeEventListener("keydown",n)},r=e=>{0===e.button&&o()},n=e=>{"Escape"===e.code&&o()}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".notice"),o=e.querySelector(".map__pins"),r=t.querySelector(".ad-form"),n=r.querySelectorAll(".ad-form > fieldset"),a=e.querySelector(".map__filters-container").querySelector(".map__filters").children,c=o.querySelector(".map__pin--main"),d="570px",i="375px",s=document.querySelector("#avatar"),l=document.querySelector(".ad-form-header__preview"),u=document.querySelector("#images"),p=document.querySelector(".ad-form__photo"),m=c.offsetWidth,f=c.offsetHeight,v=r.querySelector("#address");window.pageActivate={getActivePage:t=>{!e.classList.contains("map--faded")||0!==t.button&&"Enter"!==t.code||(window.util.setUnDisabledFormElements(n),window.util.setUnDisabledFormElements(a),e.classList.remove("map--faded"),r.classList.remove("ad-form--disabled"),v.value=`${Math.round(c.offsetLeft+m/2)}, ${Math.round(c.offsetTop+f+22)}`,v.readOnly=!0,window.map.getPinMap(window.data.serverData),s.addEventListener("change",window.addPreviewImage),u.addEventListener("change",window.addPreviewImage))},getDeactivePage:()=>{window.util.setDisabledFormElements(n),window.util.setDisabledFormElements(a),e.classList.add("map--faded"),r.classList.add("ad-form--disabled"),c.style.top=i,c.style.left=d,v.value=`X: ${Math.round(c.offsetLeft+m/2)}, ${Math.round(c.offsetTop+f/2)}`,window.pin.getRemovePins(),s.removeEventListener("change",window.addPreviewImage),u.removeEventListener("change",window.addPreviewImage),window.filter.resetFilters(),l.querySelector("img").src="img/muffin-grey.svg",p.replaceChildren()}}})(),(()=>{const e=document.querySelector(".map").querySelector(".map__pins"),t=e.querySelector(".map__pin--main").offsetWidth,o=document.querySelector(".map__pins"),r=document.querySelector("#pin").content.querySelector(".map__pin"),n=e=>{const o=document.createDocumentFragment();let n=e.length>5?5:n=e.length;for(let a=0;a<n;a++){const n=r.cloneNode(!0),c=n.querySelector("img");n.style.cssText=`left: ${e[a].location.x-t}px; top: ${e[a].location.y}px;`,c.src=e[a].author.avatar,c.alt=e[a].offer.title,o.appendChild(n)}return o};window.map={getPinFragment:n,getPinMap:t=>{const r=n(t);o.appendChild(r);const a=e.querySelectorAll(".map__pin:not(.map__pin--main)");let c=t.length>5?5:c=t.length;for(let e=0;e<c;e++)window.pin.onAdCardClick(a[e],t[e])}}})(),window.dragAndDrop={dragAndDropPin:(e,t,o=e)=>{const r=document.querySelector(".ad-form").querySelector("#address"),n=document.querySelector(".map__pins").querySelector(".map__pin--main"),a=n.offsetWidth,c=n.offsetHeight;e.addEventListener("mousedown",(n=>{n.preventDefault();let d={x:n.clientX,y:n.clientY},i=!1;const s=e=>{e.preventDefault(),i=!0;const n=d.x-e.clientX,s=d.y-e.clientY;d={x:e.clientX,y:e.clientY},o.style.top=o.offsetTop-s+"px",o.style.left=o.offsetLeft-n+"px",o.offsetTop<t.TOP?o.style.top=t.TOP+"px":o.offsetTop>t.BOTTOM?o.style.top=t.BOTTOM+"px":o.offsetLeft<t.LEFT?o.style.left=t.LEFT+"px":o.offsetLeft>t.RIGHT&&(o.style.left=t.RIGHT+"px"),r.value=`${Math.round(o.offsetLeft+a/2)}, ${Math.round(o.offsetTop+c+22)}`},l=t=>{if(t.preventDefault(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",l),i){const t=o=>{o.preventDefault(),e.removeEventListener("click",t)};e.addEventListener("click",t)}};document.addEventListener("mousemove",s),document.addEventListener("mouseup",l)}))}},(()=>{const e=document.querySelector(".ad-form"),t=e.querySelectorAll(".ad-form > fieldset"),o=e.querySelector("#address"),r=e.querySelector("#avatar"),n=e.querySelector("#title"),a=e.querySelector("#capacity"),c=e.querySelector("#room_number"),d=e.querySelector("#type"),i=e.querySelector("#timein"),s=e.querySelector("#timeout"),l=e.querySelector("#price"),u=e.querySelector("#description"),p=e.querySelector("#images"),m=e.querySelectorAll(".feature__checkbox"),f=document.querySelector(".map__filters").children,v=document.querySelector(".map__pins").querySelector(".map__pin--main"),y=v.offsetWidth,w=v.offsetHeight;window.util.setDisabledFormElements(t),window.util.setDisabledFormElements(f),o.value=`${Math.round(v.offsetLeft+y/2)}, ${Math.round(v.offsetTop+w/2)}`;const g=e=>{let t=0;switch(e){case"bungalow":t=0;break;case"flat":t=1e3;break;case"house":t=5e3;break;case"palace":t=1e4}l.min=t,l.placeholder=t},_=e=>{s.value=e};g(d.value),d.addEventListener("change",(e=>{g(e.target.value)})),_(i.value),i.addEventListener("change",(e=>{_(e.target.value)})),s.addEventListener("change",(e=>{var t;t=e.target.value,i.value=t}));const h={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},S=e=>{[...a.options].forEach((t=>{t.disabled=!h[e].includes(t.value)})),a.value=e>3?"0":e};S(c.value),c.addEventListener("change",(e=>{S(e.target.value)})),e.addEventListener("submit",(t=>{t.preventDefault(),window.server.send(new FormData(e),window.createSuccessMessage,window.error.uploadErrorMessageOn("Custom Error Text"))})),e.addEventListener("reset",(e=>{e.preventDefault(),S(c.value),window.pageActivate.getDeactivePage(),window.form.getResetForm()}));const q="flat",E=1e3,L=1,k="12:00",x=1;window.form={getResetForm:()=>{n.value="",d.value=q,c.value=L,l.value="",l.placeholder=E,u.value="",i.value=k,s.value=i.value,a.value=x,p.value="",r.value="",window.pin.getRemovePopup(),[...m].forEach((e=>{e.checked=!1}))}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".popup");window.card={getAdCard:t=>{const o=document.createDocumentFragment(),r=e.cloneNode(!0),{author:n,offer:a,address:c,price:d,type:i,rooms:s,guests:l,checkin:u,checkout:p}=t,m=r.querySelector(".popup__avatar");m.src=n||m.remove();const f=r.querySelector(".popup__title");f.textContent=a||f.remove();const v=r.querySelector(".popup__text--address");v.textContent=c||v.remove();const y=r.querySelector(".popup__text--price");y.textContent=d?d+" ₽/ночь":y.remove();const w=r.querySelector(".popup__type");w.textContent=i||w.remove();const g=r.querySelector(".popup__text--capacity");g.textContent=s&&l?`${s} комнат для ${l} гостей`:g.remove();const _=r.querySelector(".popup__text--time");return _.textContent=u&&p?`Заезд после ${u} выезд до ${p}`:_.remove(),((e,t)=>{const o=e.querySelector(".popup__features"),r=document.createDocumentFragment();for(let e=0;e<t.length;e++){const o=document.createElement("li");o.classList.add("popup__feature"),o.classList.add("popup__feature--"+t[e]),r.appendChild(o)}o.innerHTML="",o.appendChild(r)})(r,t.offer.features),((e,t)=>{const o=e.querySelector(".popup__photos"),r=o.querySelector("img").cloneNode(!0);o.innerHTML="";for(let e=0;e<t.length;e++){const n=r.cloneNode(!0);n.src=t[e],o.appendChild(n)}})(r,t.offer.photos),o.appendChild(r),o}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),o=e.querySelector(".map__filters-container"),r=e=>{e.classList.add("map__pin--active")},n=()=>{t.querySelectorAll(".map__pin").forEach((e=>{e.classList.remove("map__pin--active")}))},a=()=>{e.querySelector(".map__card.popup")&&(e.querySelector(".map__card.popup").remove(),document.removeEventListener("keydown",c))},c=t=>{"Escape"===t.key&&(t.preventDefault(),a(e.querySelector(".map__card.popup")),n())};window.pin={onAdCardClick:(t,d)=>{t.addEventListener("click",(()=>{e.querySelector(".map__card.popup")?(n(),a(),r(t)):r(t),e.insertBefore(window.card.getAdCard(d),o),document.addEventListener("keydown",c),e.querySelector(".popup__close").addEventListener("click",(()=>{a(),n()}))}))},getRemovePopup:a,getUnactivatePin:n,getRemovePins:()=>{t.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),300)}},(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),r=e.querySelector("#housing-rooms"),n=e.querySelector("#housing-guests"),a=e.querySelectorAll(".map__checkbox");e.addEventListener("change",window.debounce((()=>{let e=window.data.serverData.slice();window.pin.getRemovePopup(),window.pin.getRemovePins(),a.forEach((t=>{if(t.checked){const o=t.id.replace(/filter-/gi,"");e=e.filter((e=>e.offer.features.includes(o)))}})),[{name:t,filterFunction:t=>{e=e.filter((e=>e.offer.type===t))}},{name:o,filterFunction:t=>{e=e.filter((e=>{switch(t){case"middle":return e.offer.price>=1e4&&e.offer.price<=5e4;case"low":return e.offer.price<1e4;case"high":return e.offer.price>5e4;default:return!1}}))}},{name:r,filterFunction:t=>{e=e.filter((e=>e.offer.rooms===Number(t)))}},{name:n,filterFunction:t=>{e=e.filter((e=>e.offer.guests===Number(t)))}}].forEach((e=>{const t=e.name.value;"any"!==t&&e.filterFunction(t)})),window.map.getPinMap(e)}))),window.filter={resetFilters:()=>{e.querySelectorAll("select").forEach((e=>{e.value="any"})),a.forEach((e=>{e.checked=!1}))}}})(),(()=>{const e=document.querySelector(".ad-form-header__preview"),t=document.querySelector(".ad-form__photo"),o=["jpg","jpeg","png"],r={avatar:e,images:t};window.addPreviewImage=e=>{const t=e.target.files[0],n=t.name.toLowerCase();if(o.some((e=>n.endsWith(e)))){let o=new FileReader;o.addEventListener("load",(()=>{r[e.target.id].replaceChildren(),r[e.target.id].style.display="flex",r[e.target.id].style.justifyContent="center";const t=document.createElement("img");t.src=o.result,t.alt="Превью добавленного изображеия",t.style.width="70px",t.style.height="70px",t.style.borderRadius="5px",r[e.target.id].appendChild(t)})),o.readAsDataURL(t)}}})(),(()=>{const e=document.querySelector(".map__pins").querySelector(".map__pin--main"),t=e.offsetWidth,o=e.offsetHeight,r={TOP:108-o,LEFT:0-t/2,RIGHT:document.querySelector(".map").offsetWidth-t/2,BOTTOM:608-o};e.addEventListener("mousedown",window.pageActivate.getActivePage),e.addEventListener("keydown",window.pageActivate.getActivePage),window.dragAndDrop.dragAndDropPin(e,r)})()})();