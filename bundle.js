(()=>{"use strict";(()=>{const e=(e,t)=>Math.floor(Math.random()*(t-e+1))+e;window.util={getRandomIntInclusive:e,getRandomArrayElement:t=>t[e(0,t.length-1)],getDisabledElements:e=>{for(const t of e)t.disabled=!0},getUnDisabledElements:e=>{for(const t of e)t.disabled=!1}}})(),(()=>{const e=(e,t,o,r=!1)=>{let n=!1;!1!==r&&(n=!0),e.responseType="json",e.addEventListener("load",(()=>{200===e.status?t(e.response):o(`Статус ответа: ${e.status} ${e.statusText}`,n)})),e.timeout=2e3,e.addEventListener("error",(()=>{o("Произошла ошибка соеденения. Проверьте соеденение с интернетом",n)})),e.addEventListener("timeout",(()=>{o(`Запрос не успел выполниться за ${e.timeout}мс`,n)})),!1===r&&e.send()};window.server={load:(t,o)=>{const r=new XMLHttpRequest;r.open("GET","https://21.javascript.pages.academy/keksobooking/data"),e(r,t,o)},send:(t,o,r)=>{const n=new XMLHttpRequest;n.open("POST","https://21.javascript.pages.academy/keksobooking"),e(n,t,o,r)}}})(),(()=>{const e=document.querySelector("#error").content.querySelector(".error");window.errorMessage=(t,o)=>{const r=document.createDocumentFragment(),n=e.cloneNode(!0);n.querySelector(".error__message").textContent=t,r.appendChild(n),document.querySelector(".map__pins").appendChild(r);const a=n.querySelector("button"),c=()=>{n.remove(),a.removeEventListener("click",c),o||(window.server.load(window.data.getServerData,window.errorMessage),window.pageActivate.getDeactivePage())};a.addEventListener("click",c)}})(),(()=>{const e=document.querySelector("#success").content.querySelector(".success");window.successMessage=()=>{const t=document.createDocumentFragment(),o=e.cloneNode(!0);t.appendChild(o),document.querySelector("main").appendChild(t),window.pageActivate.getDeactivePage(),document.querySelector(".ad-form").reset();const r=()=>e=>{"Escape"!==e.code&&0!==e.button||(o.remove(),document.removeEventListener("click",r()),document.removeEventListener("keydown",r()))};document.addEventListener("click",r()),document.addEventListener("keydown",r())}})(),window.data={},window.data.getServerData=e=>{window.data.serverData=e.slice()},window.server.load(window.data.getServerData,window.errorMessage),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".notice"),o=e.querySelector(".map__pins"),r=t.querySelector(".ad-form"),n=r.querySelectorAll(".ad-form > fieldset"),a=e.querySelector(".map__filters-container").querySelector(".map__filters").children,c=o.querySelector(".map__pin--main"),i="570px",d="375px",l=document.querySelector("#avatar"),s=document.querySelector(".ad-form-header__preview"),u=document.querySelector("#images"),p=document.querySelector(".ad-form__photo"),m=c.offsetWidth,f=c.offsetHeight,v=r.querySelector("#address");window.pageActivate={getActivePage:()=>t=>{!e.classList.contains("map--faded")||0!==t.button&&"Enter"!==t.code||(window.util.getUnDisabledElements(n),window.util.getUnDisabledElements(a),e.classList.remove("map--faded"),r.classList.remove("ad-form--disabled"),v.value=`X: ${Math.round(c.offsetLeft+m/2)}, Y: ${Math.round(c.offsetTop+f+22)}`,v.readOnly=!0,window.map.getPinMap(window.data.serverData),l.addEventListener("change",window.previewCb),u.addEventListener("change",window.previewCb))},getDeactivePage:()=>{window.util.getDisabledElements(n),window.util.getDisabledElements(a),e.classList.add("map--faded"),r.classList.add("ad-form--disabled"),c.style.top=d,c.style.left=i,v.value=`X: ${Math.round(c.offsetLeft+m/2)}, ${Math.round(c.offsetTop+f/2)}`,window.pin.getRemovePins(),l.removeEventListener("change",window.previewCb),u.removeEventListener("change",window.previewCb),window.filter.getFilterReset(),s.querySelector("img").src="img/muffin-grey.svg",p.replaceChildren()}}})(),(()=>{const e=document.querySelector(".map").querySelector(".map__pins"),t=e.querySelector(".map__pin--main").offsetWidth,o=document.querySelector(".map__pins"),r=document.querySelector("#pin").content.querySelector(".map__pin"),n=e=>{const o=document.createDocumentFragment();let n;n=e.length>5?5:e.length;for(let a=0;a<n;a++){const n=r.cloneNode(!0),c=n.querySelector("img");n.style.cssText=`left: ${e[a].location.x-t}px; top: ${e[a].location.y}px;`,c.src=e[a].author.avatar,c.alt=e[a].offer.title,o.appendChild(n)}return o};window.map={getPinFragment:n,getPinMap:t=>{const r=n(t);o.appendChild(r);const a=e.querySelectorAll(".map__pin:not(.map__pin--main)");let c;c=t.length>5?5:t.length;for(let e=0;e<c;e++)window.pin.onAdCardClick(a[e],t[e])}}})(),window.dragAndDrop={getTransformElement:(e,t,o=e)=>{const r=document.querySelector(".ad-form").querySelector("#address"),n=document.querySelector(".map__pins").querySelector(".map__pin--main"),a=n.offsetWidth,c=n.offsetHeight;e.addEventListener("mousedown",(n=>{n.preventDefault();let i={x:n.clientX,y:n.clientY},d=!1;const l=e=>{e.preventDefault(),d=!0;const n=i.x-e.clientX,l=i.y-e.clientY;i={x:e.clientX,y:e.clientY},o.style.top=o.offsetTop-l+"px",o.style.left=o.offsetLeft-n+"px",o.offsetTop<t.top?o.style.top=t.top+"px":o.offsetTop>t.bottom?o.style.top=t.bottom+"px":o.offsetLeft<t.left?o.style.left=t.left+"px":o.offsetLeft>t.right&&(o.style.left=t.right+"px"),r.value=`Х: ${Math.round(o.offsetLeft+a/2)}, Y: ${Math.round(o.offsetTop+c+22)}`},s=t=>{if(t.preventDefault(),document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",s),d){const t=o=>{o.preventDefault(),e.removeEventListener("click",t)};e.addEventListener("click",t)}};document.addEventListener("mousemove",l),document.addEventListener("mouseup",s)}))}},(()=>{const e=document.querySelector(".ad-form"),t=e.querySelectorAll(".ad-form > fieldset"),o=e.querySelector("#address"),r=e.querySelector("#avatar"),n=e.querySelector("#title"),a=e.querySelector("#capacity"),c=e.querySelector("#room_number"),i=e.querySelector("#type"),d=e.querySelector("#timein"),l=e.querySelector("#timeout"),s=e.querySelector("#price"),u=e.querySelector("#description"),p=e.querySelector("#images"),m=e.querySelectorAll(".feature__checkbox"),f=document.querySelector(".map__filters").children,v=document.querySelector(".map__pins").querySelector(".map__pin--main"),w=v.offsetWidth,g=v.offsetHeight;window.util.getDisabledElements(t),window.util.getDisabledElements(f),o.value=`X: ${Math.round(v.offsetLeft+w/2)}, Y: ${Math.round(v.offsetTop+g/2)}`;const y=e=>{let t=0;switch(e){case"bungalow":t=0;break;case"flat":t=1e3;break;case"house":t=5e3;break;case"palace":t=1e4}s.min=t,s.placeholder=t},_=e=>{l.value=e};y(i.value),i.addEventListener("change",(e=>{y(e.target.value)})),_(d.value),d.addEventListener("change",(e=>{_(e.target.value)})),l.addEventListener("change",(e=>{var t;t=e.target.value,d.value=t}));const h={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},S=e=>{[...a.options].forEach((t=>{t.disabled=!h[e].includes(t.value)})),a.value=e>3?"0":e};S(c.value),c.addEventListener("change",(e=>{S(e.target.value)})),e.addEventListener("submit",(t=>{t.preventDefault(),window.server.send(window.successMessage,window.errorMessage,new FormData(e))})),e.addEventListener("reset",(e=>{e.preventDefault(),S(c.value),window.pageActivate.getDeactivePage(),window.form.getResetForm()}));const q="flat",E=1e3,L=1,b="12:00",D=1;window.form={getResetForm:()=>{n.value="",i.value=q,c.value=L,s.value="",s.placeholder=E,u.value="",d.value=b,l.value=d.value,a.value=D,p.value="",r.value="",window.pin.getRemovePopup(),[...m].forEach((e=>{e.checked=!1}))}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".popup");window.card={getAdCard:t=>{const o=document.createDocumentFragment(),r=e.cloneNode(!0);return r.querySelector(".popup__title").textContent=t.offer.title,r.querySelector(".popup__text--address").textContent=t.offer.address,r.querySelector(".popup__text--price").textContent=t.offer.price+" ₽/ночь",r.querySelector(".popup__type").textContent=t.offer.type,r.querySelector(".popup__text--capacity").textContent=`${t.offer.rooms} комнат для ${t.offer.guests} гостей`,r.querySelector(".popup__text--time").textContent=`Заезд после ${t.offer.checkin} выезд до ${t.offer.checkout}`,r.querySelector(".popup__avatar").src=t.author.avatar,((e,t)=>{const o=e.querySelector(".popup__features"),r=document.createDocumentFragment();for(let e=0;e<t.length;e++){const o=document.createElement("li");o.classList.add("popup__feature"),o.classList.add("popup__feature--"+t[e]),r.appendChild(o)}o.innerHTML="",o.appendChild(r)})(r,t.offer.features),((e,t)=>{const o=e.querySelector(".popup__photos"),r=o.querySelector("img").cloneNode(!0);o.innerHTML="";for(let e=0;e<t.length;e++){const n=r.cloneNode(!0);n.src=t[e],o.appendChild(n)}})(r,t.offer.photos),o.appendChild(r),o}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),o=e.querySelector(".map__filters-container"),r=e=>{e.classList.add("map__pin--active")},n=()=>{t.querySelectorAll(".map__pin").forEach((e=>{e.classList.remove("map__pin--active")}))},a=()=>{e.querySelector(".map__card.popup")&&(e.querySelector(".map__card.popup").remove(),document.removeEventListener("keydown",c))},c=t=>{"Escape"===t.key&&(t.preventDefault(),a(e.querySelector(".map__card.popup")),n())};window.pin={onAdCardClick:(t,i)=>{t.addEventListener("click",(()=>{e.querySelector(".map__card.popup")?(n(),a(),r(t)):r(t),e.insertBefore(window.card.getAdCard(i),o),document.addEventListener("keydown",c),e.querySelector(".popup__close").addEventListener("click",(()=>{a(),n()}))}))},getRemovePopup:a,getUnactivatePin:n,getRemovePins:()=>{t.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))}}})(),window.debounce=e=>{let t=null;return function(...o){t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),300)}},(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),r=e.querySelector("#housing-rooms"),n=e.querySelector("#housing-guests"),a=e.querySelectorAll(".map__checkbox");e.addEventListener("change",window.debounce((()=>{let e=window.data.serverData.slice();window.pin.getRemovePopup(),window.pin.getRemovePins(),a.forEach((t=>{if(t.checked){const o=t.id.replace(/filter-/gi,"");e=e.filter((e=>e.offer.features.includes(o)))}})),[{name:t,filterFunction:t=>{e=e.filter((e=>e.offer.type===t))}},{name:o,filterFunction:t=>{e=e.filter((e=>{switch(t){case"middle":return e.offer.price>=1e4&&e.offer.price<=5e4;case"low":return e.offer.price<1e4;case"high":return e.offer.price>5e4;default:return!1}}))}},{name:r,filterFunction:t=>{e=e.filter((e=>e.offer.price===Number(t)))}},{name:n,filterFunction:t=>{e=e.filter((e=>e.offer.price===Number(t)))}}].forEach((e=>{const t=e.name.value;"any"!==t&&e.filterFunction(t)})),window.map.getPinMap(e)}))),window.filter={getFilterReset:()=>{e.querySelectorAll("select").forEach((e=>{e.value="any"})),a.forEach((e=>{e.checked=!1}))}}})(),(()=>{const e=document.querySelector(".ad-form-header__preview"),t=document.querySelector(".ad-form__photo"),o=["jpg","jpeg","png"],r={avatar:e,images:t};window.previewCb=e=>{const t=e.target.files[0],n=t.name.toLowerCase();if(o.some((e=>n.endsWith(e)))){let o=new FileReader;o.addEventListener("load",(()=>{r[e.target.id].replaceChildren(),r[e.target.id].style.display="flex",r[e.target.id].style.justifyContent="center";const t=document.createElement("img");t.src=o.result,t.alt="Превью добавленного изображеия",t.style.width="40px",t.style.height="44px",t.style.alignSelf="center",r[e.target.id].appendChild(t)})),o.readAsDataURL(t)}}})(),(()=>{const e=document.querySelector(".map__pins").querySelector(".map__pin--main"),t=e.offsetWidth,o=e.offsetHeight,r={top:108-o,left:0-t/2,right:document.querySelector(".map").offsetWidth-t/2,bottom:608-o};e.addEventListener("mousedown",window.pageActivate.getActivePage()),e.addEventListener("keydown",window.pageActivate.getActivePage()),window.dragAndDrop.getTransformElement(e,r)})()})();